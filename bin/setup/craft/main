#!/bin/bash
set -e

apt-get -y --no-install-recommends install \
  libmcrypt-dev \
  libmagickwand-dev

docker-php-ext-configure opcache --enable-opcache

docker-php-ext-install \
  pdo_mysql \
  mcrypt \
  opcache

pecl install \
  imagick \
  redis

docker-php-ext-enable \
  imagick \
  redis

CRAFT_ARCHIVE="$(mktemp)"
CRAFT_ARCHIVE_DIR="$(mktemp -d)"
cd "$CRAFT_ARCHIVE_DIR"

curl -o"$CRAFT_ARCHIVE" "$CRAFT_ARCHIVE_URL"
apt-get -y install unzip
unzip "$CRAFT_ARCHIVE"
rm -v "$CRAFT_ARCHIVE"

mv -v craft /app
rm -vRf "$CRAFT_ARCHIVE_DIR"

mv -v /app/craft/app/etc/config/common{,_original}.php

find \
  /etc/apache2 \
  -name '*.conf' \
  -exec sed -i 's/\/var\/www\/html/\/app\/public/g' {} ';' \
  -exec sed -i 's/\/var\/www/\/app/g' {} ';'

cd /etc/apache2/mods-enabled
ln -vs ../mods-available/rewrite.load
rm -v deflate.conf deflate.load
