#!/usr/bin/env php
<?php
require __DIR__ . '/common.php';
require __DIR__ . '/vendor/autoload.php';

use malkusch\lock\mutex\PHPRedisMutex;

$mutex = new PHPRedisMutex([$redis], KEY_IN_PROGRESS, 3600);
$exitCode = $mutex->synchronized(
  function () use ($redis) {
    if (!empty($redis->get(KEY_FAILED))) {
      fwrite(STDERR, 'Halting the script becasue the previous migration failed.');
      return 1;
    }
    system(__DIR__ . '/../update-database', $exitCode);
    if ($exitCode != 0) {
      fwrite(STDERR, 'Migration failed.');
      $redis->set(KEY_FAILED, '1');
    }
    return $exitCode;
  }
);
exit($exitCode);
